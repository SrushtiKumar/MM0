#!/usr/bin/env python3
"""Test the exact vulnerability in EnhancedWebVideoSteganography"""

import sys
import os
sys.path.append(os.path.dirname(__file__))

from enhanced_web_video_stego import EnhancedWebVideoSteganography
import json

def test_encryption_vulnerability():
    """Test the encryption vulnerability"""
    
    correct_password = "correct123"
    wrong_password = "wrong456"
    
    # Create test video
    test_video = "vuln_test.mp4"
    with open(test_video, 'wb') as f:
        f.write(b"FAKE_VIDEO_DATA" * 1000)
    
    print("üîç Testing encryption vulnerability...")
    
    try:
        # 1. Hide data with correct password
        print("\n1. Hiding data with correct password...")
        hide_stego = EnhancedWebVideoSteganography(correct_password)
        hide_result = hide_stego.hide_data(test_video, "Secret test message", "vuln_output.mp4")
        
        if not hide_result['success']:
            print(f"‚ùå Hide failed: {hide_result}")
            return
        
        print("‚úÖ Data hidden successfully")
        
        # 2. Try to extract with wrong password
        print("\n2. Extracting with wrong password...")
        wrong_stego = EnhancedWebVideoSteganography(wrong_password)
        
        try:
            extracted_data, filename = wrong_stego.extract_data("vuln_output.mp4")
            
            if extracted_data and filename:
                print(f"‚ùå VULNERABILITY: Wrong password extracted data!")
                print(f"   Data: {extracted_data}")
                print(f"   Filename: {filename}")
            else:
                print("‚úÖ Wrong password properly failed")
                
        except Exception as e:
            if "wrong password" in str(e).lower() or "corruption" in str(e).lower():
                print(f"‚úÖ Wrong password properly failed with error: {e}")
            else:
                print(f"‚ö†Ô∏è  Wrong password failed with unexpected error: {e}")
        
        # 3. Test with empty password scenario
        print("\n3. Testing with empty password during hiding...")
        empty_stego = EnhancedWebVideoSteganography("")  # No password
        empty_result = empty_stego.hide_data(test_video, "Unprotected message", "empty_output.mp4")
        
        if empty_result['success']:
            print("‚úÖ Empty password hide succeeded")
            
            # Try to extract with any password
            any_password_stego = EnhancedWebVideoSteganography("anypassword")
            try:
                extracted_data, filename = any_password_stego.extract_data("empty_output.mp4")
                if extracted_data:
                    print(f"‚ùå VULNERABILITY: Any password can extract unprotected data!")
                    print(f"   Data: {extracted_data}")
                else:
                    print("‚úÖ Password protection still enforced")
            except Exception as e:
                print(f"‚úÖ Password protection enforced: {e}")
        
        # 4. Debug the encryption process
        print("\n4. Debugging encryption with wrong password...")
        test_json = '{"type": "text_message", "content": "Secret test message", "length": 19}'
        test_bytes = test_json.encode('utf-8')
        
        # Encrypt with correct password
        correct_encrypted = hide_stego._encrypt_data(test_bytes)
        print(f"   Correct encrypted: {correct_encrypted[:20]}...")
        
        # Try to decrypt with wrong password
        wrong_decrypted = wrong_stego._decrypt_data(correct_encrypted)
        print(f"   Wrong decrypted: {wrong_decrypted[:50]}...")
        
        # Try to parse as JSON
        try:
            wrong_json = json.loads(wrong_decrypted.decode('utf-8'))
            print(f"   ‚ùå CRITICAL: Wrong password produced valid JSON: {wrong_json}")
        except:
            print(f"   ‚úÖ Wrong password produced invalid JSON (as expected)")
    
    finally:
        # Cleanup
        for file in ["vuln_test.mp4", "vuln_output.mp4", "empty_output.mp4"]:
            if os.path.exists(file):
                os.remove(file)

if __name__ == "__main__":
    test_encryption_vulnerability()